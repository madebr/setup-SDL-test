name: Build (Ngage)

on: [push, pull_request]

jobs:
  build:
    name: Ngage
    runs-on: windows-latest
    strategy:
      fail-fast: false

    steps:
      - uses: actions/checkout@v3

      - name: Checkout ngage-toolchain
        uses: actions/checkout@v3
        with:
          repository: ngagesdk/ngage-toolchain
          path: ngage-toolchain
          submodules: true

      - name: Setup environment
        id: ngagesdk
        run: |
          $ngagesdk = "$pwd".replace('\', '/') + "/ngage-toolchain"
          echo "prefix=$ngagesdk" >> $Env:GITHUB_OUTPUT
          echo "$ngagesdk/sdk/6.1/Shared/EP0C32/gcc/bin" >> $Env:GITHUB_PATH

      - name: Setup toolchain
        run: |
          cmake -S "${{ steps.ngagesdk.outputs.prefix }}/setup" `
                -B "${{ steps.ngagesdk.outputs.prefix }}/setup/build" `
                -G Ninja      
          cmake --build "$NGAGESDK/setup/build"

      - uses: madebr/setup-sdl@master
        with:
          version: "2-latest"
          pre-release: false
          build-type: "Release"
          ninja: true
          cmake-toolchain-file: '${{ steps.ngagesdk.outputs.prefix }}/cmake/ngage-toolchain.cmake'

      - name: Configure (CMake)
        run: |
          cmake -S . `
                -B build `
                -G Ninja `
                -DCMAKE_TOOLCHAIN_FILE=${{ env.NGAGESDK }}/cmake/ngage-toolchain.cmake

      - name: Build (CMake)
        run: cmake --build build --verbose
